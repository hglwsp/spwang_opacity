clc; clear; close all;

% Main code for 2-d vehicle for opacity
% Succesfully found the Barrier with appropriate manually designed controller
% Main code for lcss20 example1


echo on;

%% Parameters
% 2-dimensional system
% x(t+1) = x(t) + v(t) + 0.5*u(t); v(t+1) = v(t) + u(t); y(t) = v(t)
A = [1 1; 0 1];
B = [0.5; 1];
C = [0 1];

% 
c = 1;
delta = 1;
epsilon_1 =1;
epsilon_2 =1.001;  % epsilon_2 >= epsilon_1
kappa = 1 ;     % constant kappa in the last condition

%% SOS Program
% define variables required for SOS program
syms x1 x2 v1 v2 u1;
vars = [x1; x2; v1; v2; u1];

% define lower and upper bounds
X_min = [0; 0];
X_max = [10; 10];
X_0_min = X_min;
X_0_max = X_max;
X_s_min = [0; 0];
X_s_max = [1; 1];
X_ns_min = X_s_max;
X_ns_max = X_max;
V_min = [0; 0];
%V_max = [0.3; 0.3];
V_max = [0.1; 0.1]; 
% U_min = [-0.1; -0.1];
% U_max = [0.1; 0.1];
U_min = [-0.05; -0.05];
U_max = [0.05; 0.05]; 
% U_min = [-0.01; -0.01];
% U_max = [0.01; 0.01]; 

% control region
U1_all = (u1-U_min(1))*(U_max(1)-u1);


% all region
X1_all = (x1-X_min(1))*(X_max(1)-x1);
X2_all = (x2-X_min(2))*(X_max(2)-x2);
X_all  = [X1_all; X2_all];    
V1_all = (v1-V_min(1))*(V_max(1)-v1);
V2_all = (v2-V_min(2))*(V_max(2)-v2); 
V_all  = [V1_all; V2_all];

% initial region
% The polynomial functions for defining the semialgebraic region R_0(X_initial here);
g_01 = (x1-X_s_min(1))*(X_s_max(1)-x1); 
g_02 = (x2-X_ns_min(2))*(X_ns_max(2)-x2);
g_03 = -(c*x1-c*x2)^2+delta^2;
g_04 = V1_all;
g_05 = V2_all;
g_0  = [g_01; g_02; g_03; g_04; g_05];

% unsafe region
% The polynomial functions for defining the semialgebraic region R_u(X_unsafe here);
g_u1 = (x1-X_min(1))*(X_max(1)-x1); 
g_u2 = (x2-X_min(2))*(X_max(2)-x2);
g_u3 = (c*x1-c*x2)^2-delta^2-0.01;
g_u4 = V1_all;
g_u5 = V2_all;
g_u  = [g_u1; g_u2; g_u3; g_u4; g_u5];



% third condition B(f(x,u),f(x',u'))
f_x1 = x1 + v1 + 0.5*u1;
f_v1 = v1 + 1*u1;

 %u2 = 0.6*x1-0.6*x2+1.2*v1-1.2*v2+u1;
u2 = 0.8*x1-0.8*x2+1.5*v1-1.5*v2+u1;
%u2 = 2*x1-2*x2+2*v1-2*v2+u1;
%u2 =  0.0636*x1-0.0636*x2+0.3568*v1-0.3568*v2;
% u2 =  0.0883*x1-0.0883 *x2+0.4203*v1-0.4203*v2+u1;
% u2 =  0.0605*x1-0.0605*x2+0.3478*v1-0.3478*v2+u1;
% u2 =  0.0030*x1-0.0030*x2+0.0780*v1-0.0780*v2+u1;

f_x2 = x2 + v2 + 0.5*u2;
f_v2 = v2 + 1*u2;



% show results
Barrier_function = [1.91633909505741*x1 + 1.63161720515772*x2 - 0.691373149823091*v1 - 0.306050037559266*v2...
    + 0.74439334152581*((-1.29214507868976*x1 + 1.05939101125042*x2 + 0.090875040939404*v1 - 0.0197920578513366*v2 + 0.101793076349676)*(-0.323036269672441*x1 + 0.264847752812605*x2 + 0.022718760234851*v1 - 0.00494801446283415*v2 + 0.0254482690874191) + 0.001)^0.5 ...
    - 0.0937284651802169*((-0.631483792304509*x1 + 0.682016598109904*x2 + 0.82895518488085*v1 + 0.135177376260309*v2 - 1.40706767998709)*(-0.157870948076127*x1 + 0.170504149527476*x2 + 0.207238796220213*v1 + 0.0337943440650773*v2 - 0.351766919996772) + 0.001)^0.5 ... 
    +0.664427518517923*((-0.617311695697678*x1 + 0.0679666687283074*x2 + 0.199438112122576*v1 - 0.647920674865276*v2 + 0.329319617317032)*(-0.154327923924419*x1 + 0.0169916671820768*x2 + 0.0498595280306441*v1 - 0.161980168716319*v2 + 0.082329904329258) + 0.001)^0.5... 
    + 0.162941592682893*((0.164941554723773*x1 - 0.547772787211726*x2 - 0.592253247722577*v1 + 0.14577475617821*v2 + 0.467208244182364)*(0.659766218895092*x1 - 2.1910911488469*x2 - 2.36901299089031*v1 + 0.583099024712839*v2 + 1.86883297672946) + 0.001)^0.5... 
    - 0.102793879768042*((0.167155852510741*x1 - 0.145377851472576*x2 + 0.261219728003486*v1 - 0.10524147526715*v2 + 0.112325665890826)*(0.668623410042965*x1 - 0.581511405890302*x2 + 1.04487891201394*v1 - 0.4209659010686*v2 + 0.449302663563305) + 0.001)^0.5...
    - 0.366672425687758*((0.230840654792214*x1 - 0.107701989519122*x2 + 0.0875452859012349*v1 + 0.0431892136829889*v2 - 0.48909198653815)*(0.923362619168855*x1 - 0.430807958076488*x2 + 0.350181143604939*v1 + 0.172756854731955*v2 - 1.9563679461526) + 0.001)^0.5...
    - 1.38826553480533*((0.237873754876024*x1 + 0.200226104047604*x2 - 0.289091900844285*v1 - 0.0139091895654039*v2 + 0.0424727270270675)*(0.951495019504095*x1 + 0.800904416190415*x2 - 1.15636760337714*v1 - 0.0556367582616157*v2 + 0.16989090810827) + 0.001)^0.5...
    - 0.423173589856945*((0.256020801253667*x1 - 0.286099751856264*x2 + 0.0077722195157075*v1 - 0.00284827849197672*v2 + 0.374570572924657)*(1.02408320501467*x1 - 1.14439900742506*x2 + 0.03108887806283*v1 - 0.0113931139679069*v2 + 1.49828229169863) + 0.001)^0.5...
    - 0.622731773020229*((0.530219212666608*x1 + 0.263582367149506*x2 - 0.252894537785858*v1 + 0.324685683441493*v2 - 0.60851184688866)*(2.12087685066643*x1 + 1.05432946859802*x2 - 1.01157815114343*v1 + 1.29874273376597*v2 - 2.43404738755464) + 0.001)^0.5...
    - 0.639593407827727*((0.692113331550559*x1 + 0.418220597854517*x2 + 0.0371731976237581*v1 - 0.315032399626067*v2 + 0.566779304564908)*(2.76845332620224*x1 + 1.67288239141807*x2 + 0.148692790495032*v1 - 1.26012959850427*v2 + 2.26711721825963) + 0.001)^0.5...
    + 0.511083025710317];


%% test dynamics & plot
bc_fh = matlabFunction(Barrier_function, 'Vars', [x1,x2,v1,v2]);
% test_simu_0730;
test_simu_0818;